@model IEnumerable<StockManagement.Models.ViewModels.OrderModels.CustomerOrderSummaryViewModel>

<h3>Müşteri Sipariş Özeti</h3>
<a asp-action="CreateOrder" class="btn btn-success mb-3">Yeni Sipariş</a>
<a asp-action="Index" asp-controller="Home" class="btn btn-secondary mb-3">Geri Dön</a>

<table class="table table-bordered">
    <thead>
        <tr><th>Müşteri</th><th>Email</th><th>Aktif Sipariş</th><th>İptal Edilen</th><th>Ara Toplam</th><th>KDV</th><th>Toplam</th><th>Son Sipariş</th><th></th></tr>
    </thead>
    <tbody>
        @foreach (var customer in Model)
        {
            <tr>
                <td>@customer.CustomerName</td>
                <td>@customer.CustomerEmail</td>
                <td>@customer.OrderCount</td>
                <td>@customer.CancelledOrderCount</td>
                <td>@customer.TotalAmount.ToString("C")</td>
                <td>@customer.TotalTax.ToString("C")</td>
                <td>@customer.GrandTotal.ToString("C")</td>
                <td>@customer.LastOrderDate.ToShortDateString()</td>
                <td>
                    <button type="button" class="btn btn-primary btn-sm" onclick="loadCustomerOrders('@customer.CustomerId')">
                        Detay
                    </button>
                </td>
            </tr>
        }
    </tbody>
</table>

<div id="modalContainer"></div>

@section Scripts {
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/orderHub")
            .build();

        connection.start().then(function () {
            console.log("SignalR Connected");
        }).catch(function (err) {
            console.error(err.toString());
        });

        connection.on("NewOrderCreated", function (order) {
            showOrderNotification(order);
            updateOrderTable(order);
        });

        connection.on("OrderCancelled", function (order) {
            showCancelledNotification(order);
            updateOrderTable(order);
        });

        function showOrderNotification(order) {
            const notification = $(`
                <div class="alert alert-success alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                    <strong>Yeni Sipariş!</strong><br>
                    Sipariş No: ${order.orderNo}<br>
                    Müşteri: ${order.customerName}<br>
                    Tutar: ${order.totalPrice.toLocaleString('tr-TR', {style: 'currency', currency: 'TRY'})}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            $('body').append(notification);
            
            setTimeout(function() {
                notification.alert('close');
            }, 5000);
        }

        function showCancelledNotification(order) {
            const notification = $(`
                <div class="alert alert-danger alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                    <strong>Sipariş İptal Edildi!</strong><br>
                    Sipariş No: ${order.orderNo}<br>
                    Müşteri: ${order.customerName}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            $('body').append(notification);
            
            setTimeout(function() {
                notification.alert('close');
            }, 5000);
        }

        function updateOrderTable(order) {
            $.ajax({
                url: '@Url.Action("GetAllOrders", "Order")',
                type: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function(data) {
                    $('tbody').html(data);
                },
                error: function() {
                    console.error('Tablo güncellenirken hata oluştu');
                }
            });
        }

        function loadCustomerOrders(customerId) {
            $.get('@Url.Action("GetCustomerOrders", "Order")', { customerId: customerId }, function(data) {
                $('#modalContainer').html(data);
                $('#customerOrdersModal').modal('show');
            }).fail(function() {
                alert('Veriler yüklenirken bir hata oluştu.');
            });
        }
    </script>
}